# load compile stack
source /opt/intel/impi/5.0.3.048/intel64/bin/mpivars.sh
source /opt/intel/compiler/2015.5.223/bin/iccvars.sh intel64
export CXX=icpc
export CC=icc
export FC=ifort
export CFLAGS="-O3 -xHost"
export CXXFLAGS=$CFLAGS
export FCFLAGS=$CFLAGS

# target
base=/path/to/install/dir

# python
tar xvfz src/Python-2.7.10.tgz
cd Python-2.7.10
./configure --prefix=$base/python-2.7.10 --without-gcc --enable-unicode=ucs4 | tee loki-conf
make | tee loki-make
make install | tee loki-inst
cd ..

export PYTHONHOME=$base/python-2.7.10
export PYTHONPATH=$base/python-2.7.10/lib
export PATH=$base/python-2.7.10/bin:$PATH

# ASE
tar xvfz src/python-ase-3.9.1.4567.tar.gz
cd python-ase-3.9.1.4567
python setup.py install --prefix=$base/ase-3.9.1 | tee loki-inst
cd ..
cd $base/ase-3.9.1
mv -i lib/python2.7/site-packages/* lib/
rmdir lib/python2.7/site-packages
rmdir lib/python2.7
cd -
export PYTHONPATH=$base/ase-3.9.1/lib:$PYTHONPATH
export PATH=$base/ase-3.9.1/bin:$PATH

# numpy
tar xvfz src/numpy-1.9.2.tar.gz
cp setup/site.cfg numpy-1.9.2/
cd numpy-1.9.2 
patch numpy/distutils/fcompiler/intel.py ../setup/patch-intel.diff
patch numpy/distutils/intelccompiler.py ../setup/patch-intelcompiler.diff
python setup.py config --compiler=intelem build_clib --compiler=intelem build_ext --compiler=intelem install | tee loki-conf
cd ..

# nose
tar xvfz src/nose-1.3.7.tar.gz
cd nose-1.3.7
python setup.py install | tee loki-inst
cd ..

# libxc
tar xvfz src/libxc-2.1.2.tar.gz
cd libxc-2.1.2
./configure --prefix=$base/libxc-2.1.2 --enable-shared | tee loki-conf
make | tee loki-make
make install | tee loki-inst
cd ..
export LIBXCDIR=$base/libxc-2.1.2
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$base/libxc-2.1.2/lib

# cython
tar xvfz src/Cython-0.23.tar.gz
cp -r Cython-0.23 $base/cython-0.23
export PYTHONPATH=$base/cython-0.23:$PYTHONPATH
export PATH=$base/cython-0.23/bin:$PATH

### install pymic according to kommand-pymic in a _separate shell_
### ... and afterwards continue with
cd $base/pymic/
source ./env.sh
cd -

# gpaw-setups
tar xvfz src/gpaw-setups-0.9.11271.tar.gz
cp -r gpaw-setups-0.9.11271 $base/gpaw-setups-0.9.11271
export GPAW_SETUP_PATH=$base/gpaw-setups-0.9.11271

# load mpss
source /opt/intel/mpss/3.5.37182/etc/mpss_vars.sh
unset LDFLAGS
export CXX=icpc
export CC=icc
export FC=ifort
export CFLAGS="-O3 -xHost"
export CXXFLAGS=$CFLAGS
export CPPFLAGS=$CFLAGS
export FCFLAGS=$CFLAGS
# gpaw
tar xvfz src/gpaw-mic.tar.gz
cp setup/customize_mic.py gpaw-mic/
cd gpaw-mic
python setup.py install --customize=customize_mic.py --prefix=$base/gpaw-mic | tee loki-inst
cd gpaw/mic
make
cp libmicblas.so $base/gpaw-mic/lib/python2.7/site-packages/gpaw/mic/
cd ../../..

# set up a script for loading the stack
sed -e "s|<BASE>|$base|" load.sh > $base/load.sh

